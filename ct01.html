<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CT01 ‚Äì T·ªù khai thay ƒë·ªïi th√¥ng tin c∆∞ tr√∫ (Nh·∫≠p li·ªáu + Preview + In/PDF)</title>

  <link rel="stylesheet" href="./style.css">

  <style>
    :root{
      /* ‚úÖ LIGHT THEME */
      --bg:#ffffff;
      --card:#ffffff;
      --card2:#f7f8fb;
      --text:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;

      --accent:#2563eb;
      --ok:#16a34a;
      --danger:#dc2626;
      --warn:#d97706;

      --radius:16px;

      /* A4 tokens */
      --a4w:210mm;
      --a4h:297mm;
      --pad:12mm;
      --printText:#111;
      --printLine:#000;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
    }

    .wrap{
      margin: 24px auto;
      max-width: 1700px;
      padding: 0 16px 28px;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      margin: 14px 0;
      flex-wrap: wrap;
    }
    .title{ display:flex; flex-direction:column; gap:6px; }
    .title h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .title p{ margin:0; color:var(--muted); font-size:13px; line-height:1.4; }

    .actions{
      display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition:.15s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: #f8fafc; }
    .btn.primary{ background:rgba(37,99,235,.10); border-color:rgba(37,99,235,.35); }
    .btn.primary:hover{ background:rgba(37,99,235,.16); }
    .btn.ok{ background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.30); }
    .btn.warn{ background:rgba(217,119,6,.10); border-color:rgba(217,119,6,.30); }
    .btn.danger{ background:rgba(220,38,38,.08); border-color:rgba(220,38,38,.25); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 14px 38px rgba(15,23,42,.08);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:12px 14px;
      font-size:14px;
      letter-spacing:.2px;
      border-bottom:1px solid var(--line);
      background: var(--card2);
    }
    .card .body{ padding:14px; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .row1{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (max-width: 680px){
      .row, .row3{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      font-weight:700;
    }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{ min-height: 92px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 3px rgba(37,99,235,.15);
    }
    .hint{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top:8px;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
    }
    .table th, .table td{
      border-bottom:1px solid var(--line);
      padding:8px;
      font-size:13px;
      vertical-align:top;
    }
    .table th{
      background: var(--card2);
      text-align:left;
      
    }
    .table td input{
      padding:8px;
      border-radius:10px;
      font-size:13px;
      background:#fff;
    }
    .table tr:last-child td{ border-bottom:none; }

    .subactions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    /* Preview A4 */
    .previewShell{ padding:14px; background: #fafafa; }

    /* ‚úÖ Viewport ƒë·ªÉ A4 co gi√£n theo giao di·ªán (in v·∫´n A4) */
    .a4Viewport{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      overflow:auto;
      padding:10px;
    }
    #a4{
      transform-origin: top center;
      will-change: transform;
    }

    .a4{
      width: var(--a4w);
      min-height: var(--a4h);
      margin: 0 auto;
      background:#fff;
      color: var(--printText);
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0,0,0,.12);
      padding: var(--pad);
      font-family: "Times New Roman", Times, serif;
      border: 1px solid #e5e7eb;
    }

    .center{ text-align:center; }

    .line{
      display:inline-block;
      border-bottom: 1px dotted #111;
      min-width: 90mm;
      transform: translateY(-2px);
    }
    .line.filled{ border-bottom: none !important; }
    .fill{ font-weight:700; }

    .boxes{
      display:inline-flex;
      margin-left:2mm;
      transform: translateY(2px);
    }
    .box{
      width:7mm;
      height:8mm;
      border:1px solid #111;
      border-left:0 ;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13pt;
      font-weight:700;
    }
    .box1{ border:1px solid #111; }

    .cccd{ height:auto; align-items:center; }

    .hr{
      margin:6mm 0 4mm;
      border-top:1px solid #111;
      opacity:.10;
    }

    .printTable{
      width:100%;
      border-collapse:collapse;
      margin-top:3mm;
      font-size:11pt;
    }
    .printTable th, .printTable td{
      border:1px solid #111;
      padding:3mm 2mm;
      vertical-align:top;
    }
    .printTable th{ text-align:center; font-weight:700; }

    .sigRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap:5mm;
      margin-top:6mm;
      font-size:10.5pt;
      margin-left: -30px;
    }
    .sig{
      text-align:center;
      min-height: 35mm;
      width: 180px;
    }
    .ddmmyy{
      display: flex;
      width: 108%;
      font-size:10pt;
    }
    .sig .cap{
      margin-top: 1.5mm;
      width: 102%;
      font-weight:700;
      text-transform:uppercase;
      font-size:11pt;
      margin-bottom:2mm;
    }
    .sig .note{ font-size:9pt; }
    .sig .fillName{ margin-top:18mm; font-weight:700; }

    /* Print only */
    @media print{
      body{ background:#fff; }
      #nav-host{ display:none !important; }
      .wrap, .topbar, .grid{ display:none !important; }
      .printOnly{ display:block !important; padding:0 !important; margin:0 !important; }
      .a4{
        box-shadow:none !important;
        border-radius:0 !important;
        width:210mm !important;
        min-height:297mm !important;
        padding:12mm !important;
        border:none !important;
      }
    }
    .printOnly{ display:none; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      background: var(--card2);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      margin-top:10px;
      font-weight:700;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background:#fff;
      border:1px solid var(--line);
      padding:2px 6px;
      border-radius:8px;
      color:#0f172a;
      font-size:12px;
      font-weight:800;
    }

    .printLine{
      display:flex;
      gap:2mm;
      margin-top:5mm;
      font-size:13pt;
    }
    .printLine .lbl{ white-space:nowrap; }
    .printLine .line{
      flex:1;
      min-width:0 !important;
      display:block;
      transform:none;
      vertical-align:baseline;
    }

    .printGrid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10mm;
      align-items:end;
      margin-top:5mm;
    }

    .printLineLong{ align-items:flex-start; }
    .printLineLong .val{ flex:1; min-width:0; }
    .printLineLong .val .line{
      width:100%;
      display:block;
      min-width:0 !important;
      border-bottom:1px dotted #111;
    }
    .printLineLong .val .fill{
      white-space:normal;
      word-break:break-word;
    }

    .invalid{
      border-color: rgba(220,38,38,.70) !important;
      box-shadow: 0 0 0 3px rgba(220,38,38,.12) !important;
    }
    .fieldError{
      margin-top:6px;
      font-size:12px;
      color: var(--danger);
      font-weight:700;
      line-height:1.35;
    }

    #sigDeclarer[readonly]{
      background:#f8fafc;
      cursor:not-allowed;
    }
    /* ‚úÖ Field 10: wrap v·ªÅ l·ªÅ tr√°i (d√≤ng 2 th·∫≥ng c·ªôt v·ªõi "10. N·ªôi...") */
    .printPara10{
      margin-top: 5mm;
      font-size: 13pt;
      line-height: 1.35;
      padding-left: 7mm;  
      text-indent: -7mm;
    }
    .printPara10 .lbl{
      font-weight: normal;
      
    }
    .printPara10 .txt{
      font-weight: 700;
      
    }
    .printPara10 .txt.empty{
      font-weight: normal;
      border-bottom: 1px dotted #111;
      display: inline-block;
      min-width: 120mm;
     
    }

  </style>
</head>

<body>
  <div id="nav-host"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>CT01 ‚Äì Nh·∫≠p li·ªáu ‚Üí Preview ‚Üí In/L∆∞u PDF (A4)</h1>
        <p>
          C√¥ng c·ª• h·ªó tr·ª£ ƒëi·ªÅn CT01 ƒë·ªÉ in/l∆∞u. B·∫°n v·∫´n n√™n ƒë·ªëi chi·∫øu l·∫°i v·ªõi m·∫´u CT01 b·∫°n ƒëang d√πng tr√™n C·ªïng DVC/VNeID tr∆∞·ªõc khi n·ªôp.
        </p>
        <div class="badge">
          üí° G·ª£i √Ω: Nh·∫•n <span class="kbd">Ctrl</span> + <span class="kbd">P</span> ‚Üí ‚ÄúSave as PDF‚Äù ƒë·ªÉ t·∫£i file PDF
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnPreview" type="button">üëÄ C·∫≠p nh·∫≠t Preview</button>
        <button class="btn ok" id="btnPrint" type="button">üñ®Ô∏è In / L∆∞u PDF</button>
        <button class="btn warn" id="btnDownloadJson" type="button">‚¨áÔ∏è T·∫£i JSON</button>
        <button class="btn" id="btnLoadJson" type="button">‚¨ÜÔ∏è N·∫°p JSON</button>
        <button class="btn danger" id="btnReset" type="button">üßπ X√≥a d·ªØ li·ªáu</button>
      </div>
    </div>

    <div class="grid">
      <!-- INPUT -->
      <div class="card">
        <h2>1) Nh·∫≠p th√¥ng tin</h2>
        <div class="body">
          <div class="row1">
            <div>
              <label>K√≠nh g·ª≠i (1)</label>
              <input id="agency" placeholder="VD: C√¥ng an ph∆∞·ªùng ..., TP. H·ªì Ch√≠ Minh" value="C√¥ng an ph∆∞·ªùng B√¨nh C∆°, TP. H·ªì Ch√≠ Minh"/>
              <div class="hint">Ghi ƒë√∫ng c∆° quan ti·∫øp nh·∫≠n h·ªì s∆° (C√¥ng an c·∫•p x√£/ph∆∞·ªùng‚Ä¶ ho·∫∑c n∆°i c√≥ th·∫©m quy·ªÅn).</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>1. H·ªç, ch·ªØ ƒë·ªám v√† t√™n khai sinh</label>
              <input id="fullName" placeholder="VD: NGUY·ªÑN VƒÇN A" />
            </div>
            <div>
              <label>3. Gi·ªõi t√≠nh</label>
              <select id="gender">
                <option value="">-- Ch·ªçn --</option>
                <option>Nam</option>
                <option>N·ªØ</option>
                <option>Kh√°c</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>2. Ng√†y, th√°ng, nƒÉm sinh</label>
              <input id="dob" placeholder="dd/mm/yyyy" />
              <div class="hint">VD: 01/01/2000</div>
            </div>
            <div>
              <label>4. S·ªë ƒë·ªãnh danh c√° nh√¢n (12 s·ªë)</label>
              <input id="idNumber" maxlength="12" inputmode="numeric" placeholder="VD: 012345678901" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>5. S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá</label>
              <input id="phone" placeholder="VD: 09xxxxxxxx" />
            </div>
            <div>
              <label>6. Email</label>
              <input id="email" placeholder="VD: abc@gmail.com" />
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>7. H·ªç, ch·ªØ ƒë·ªám v√† t√™n ch·ªß h·ªô</label>
              <input id="householdHeadName" placeholder="VD: TR·∫¶N VƒÇN B" />
            </div>

            <div>
              <label>8. M·ªëi quan h·ªá v·ªõi ch·ªß h·ªô</label>
              <input id="relationToHead" placeholder="VD: Con / V·ª£ / Ch·ªìng / Thu√™ tr·ªç..." value="Ng∆∞·ªùi Thu√™ Tr·ªç"/>
            </div>
          </div>

          <div class="row">
            <div>
              <label>9. S·ªë ƒë·ªãnh danh c√° nh√¢n c·ªßa ch·ªß h·ªô (12 s·ªë)</label>
              <input id="headIdNumber" maxlength="12" inputmode="numeric" placeholder="VD: 012345678901" />
            </div>
            <div>
              <label>Tu·ª≥ ch·ªçn: Lo·∫°i y√™u c·∫ßu</label>
              <select id="requestType">
                <option value="tamtru">ƒêƒÉng k√Ω t·∫°m tr√∫</option>
                <option value="dieuchinh">ƒêi·ªÅu ch·ªânh th√¥ng tin c∆∞ tr√∫</option>
                <option value="xacnhan">X√°c nh·∫≠n th√¥ng tin c∆∞ tr√∫</option>
                <option value="khac">Kh√°c (t·ª± nh·∫≠p n·ªôi dung)</option>
              </select>
            </div>
          </div>

          <div class="card" style="margin-top:12px; background: var(--card2); border-color: var(--line); box-shadow:none">
            <h2 style="border-bottom:1px solid var(--line); background: transparent;">2) D·ª±ng ‚ÄúN·ªôi dung ƒë·ªÅ ngh·ªã‚Äù (10) nhanh (ƒë·∫∑c bi·ªát cho ƒëƒÉng k√Ω t·∫°m tr√∫)</h2>
            <div class="body">
              <div class="row1">
                <div>
                  <label>ƒê·ªãa ch·ªâ n∆°i ƒë·ªÅ ngh·ªã ƒëƒÉng k√Ω t·∫°m tr√∫</label>
                  <input id="tempAddress" placeholder="VD: 12/3 ƒê∆∞·ªùng ABC, P. ..., Q. ..., TP. ..." />
                </div>
              </div>
              <div class="row3">
                <div>
                  <label>T·ª´ ng√†y</label>
                  <input id="fromDate" placeholder="dd/mm/yyyy" />
                </div>
                <div>
                  <label>ƒê·∫øn ng√†y (c√≥ th·ªÉ ƒë·ªÉ tr·ªëng)</label>
                  <input id="toDate" placeholder="dd/mm/yyyy" />
                </div>
                <div>
                  <label>L√Ω do / ghi ch√∫</label>
                  <input id="reason" placeholder="VD: Thu√™ tr·ªç ƒë·ªÉ l√†m vi·ªác/h·ªçc t·∫≠p..." value="Thu√™ tr·ªç"/>
                </div>
              </div>
              <div class="hint">N·∫øu b·∫°n ch·ªçn ‚ÄúKh√°c‚Äù, b·∫°n c√≥ th·ªÉ nh·∫≠p n·ªôi dung ƒë·ªÅ ngh·ªã t·ª± do ·ªü √¥ (10) b√™n d∆∞·ªõi.</div>
            </div>
          </div>

          <div class="row1" style="margin-top:12px">
            <div>
              <label>10. N·ªôi dung ƒë·ªÅ ngh·ªã (2)</label>
              <textarea id="requestContent" placeholder="N·ªôi dung s·∫Ω t·ª± g·ª£i √Ω theo lo·∫°i y√™u c·∫ßu, b·∫°n c√≥ th·ªÉ s·ª≠a l·∫°i cho ƒë√∫ng th·ª±c t·∫ø..."></textarea>
              <div class="hint">‚úÖ T·ª± g·ª£i √Ω s·∫Ω c·∫≠p nh·∫≠t theo ‚ÄúCh·ªß h·ªô/ƒê·ªãa ch·ªâ/T·ª´ ng√†y‚Ä¶‚Äù. N·∫øu b·∫°n t·ª± g√µ v√†o √¥ n√†y th√¨ h·ªá th·ªëng s·∫Ω kh√¥ng t·ª± ghi ƒë√® n·ªØa.</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row1">
            <div>
              <label>11. Nh·ªØng th√†nh vi√™n trong h·ªô gia ƒë√¨nh c√πng thay ƒë·ªïi (n·∫øu c√≥)</label>
              <table class="table" id="membersTable">
                <thead>
                  <tr>
                    <th style="width:48px">TT</th>
                    <th>H·ªç, ch·ªØ ƒë·ªám v√† t√™n</th>
                    <th style="width:140px">Ng√†y sinh</th>
                    <th style="width:90px">Gi·ªõi t√≠nh</th>
                    <th style="width:170px">S·ªë ƒë·ªãnh danh</th>
                    <th style="width:150px">Quan h·ªá v·ªõi ch·ªß h·ªô</th>
                    <th style="width:56px"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>

              <div class="subactions">
                <button class="btn" id="btnAddMember" type="button">‚ûï Th√™m th√†nh vi√™n</button>
              </div>
              <div class="hint">N·∫øu kh√¥ng c√≥ ai c√πng thay ƒë·ªïi, c·ª© ƒë·ªÉ tr·ªëng b·∫£ng n√†y.</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Ng√†y l·∫≠p t·ªù khai</label>
              <input id="declareDate" placeholder="dd/mm/yyyy" />
            </div>
            <div>
              <label>ƒê·ªãa danh (vd: TP. H·ªì Ch√≠ Minh)</label>
              <input id="place" placeholder="VD: TP. H·ªì Ch√≠ Minh" />
            </div>
          </div>

          <div class="row3">
            <div>
              <label>Ch·ªß h·ªô (t√™n ƒë·ªÉ hi·ªán ·ªü ph·∫ßn ch·ªØ k√Ω)</label>
              <input id="sigHead" placeholder="(K√Ω, ghi r√µ h·ªç t√™n) ‚Äì n·∫øu c√≥" />
            </div>
            <div>
              <label>Ch·ªß s·ªü h·ªØu ch·ªó ·ªü h·ª£p ph√°p (t√™n)</label>
              <input id="sigOwner" placeholder="(K√Ω, ghi r√µ h·ªç t√™n) ‚Äì n·∫øu c√≥" />
            </div>
            <div>
              <label>Cha/M·∫π/Ng∆∞·ªùi gi√°m h·ªô (t√™n)</label>
              <input id="sigGuardian" placeholder="(K√Ω, ghi r√µ h·ªç t√™n) ‚Äì n·∫øu c√≥" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Ng∆∞·ªùi k√™ khai (t√™n) ‚Äî t·ª± ƒë·ªông = H·ªç t√™n khai sinh</label>
              <input id="sigDeclarer" placeholder="(K√Ω, ghi r√µ h·ªç t√™n)" readonly>
              <div class="hint">Tr∆∞·ªùng n√†y t·ª± ƒë·ªông l·∫•y theo ‚ÄúH·ªç, ch·ªØ ƒë·ªám v√† t√™n khai sinh‚Äù.</div>
            </div>
            <div>
              <label>Ghi ch√∫ th√™m (tu·ª≥ ch·ªçn)</label>
              <input id="extraNote" placeholder="VD: N·ªôp online qua DVC/VNeID..." />
            </div>
          </div>
        </div>
      </div>

      <!-- PREVIEW -->
      <div class="card">
        <h2>2) Preview CT01 (A4)</h2>
        <div class="previewShell">
          <div class="a4Viewport" id="a4Viewport">
            <div class="a4" id="a4"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PRINT VERSION -->
  <div class="printOnly">
    <div class="a4" id="a4Print"></div>
  </div>

  <input type="file" id="jsonFile" accept="application/json" style="display:none" />

  <script>
    // ===== NAV LOADER (optional) =====
    async function mountNav(){
      const host = document.getElementById("nav-host");
      if(!host) return;
      try{
        const res = await fetch("./nav.html", { cache:"no-store" });
        host.innerHTML = await res.text();

        const cur = (location.pathname.split("/").pop() || "index.html").toLowerCase();
        host.querySelectorAll(".nav-link").forEach(a => {
          const m = (a.dataset.match || "").toLowerCase();
          if(m === cur) a.classList.add("active");
        });

        const nav = host.querySelector(".site-nav");
        const toggle = host.querySelector(".nav-toggle");
        if(toggle && nav){
          toggle.addEventListener("click", () => {
            const isOpen = nav.classList.toggle("open");
            toggle.setAttribute("aria-expanded", String(isOpen));
          });
        }
      }catch(e){}
    }
    mountNav();

    // ===== CT01 APP =====
    const $ = (id) => document.getElementById(id);

    const state = {
      agency: "",
      fullName: "",
      dob: "",
      gender: "",
      idNumber: "",
      phone: "",
      email: "",
      householdHeadName: "",
      relationToHead: "",
      headIdNumber: "",
      requestType: "tamtru",

      tempAddress: "",
      fromDate: "",
      toDate: "",
      reason: "",

      requestContent: "",
      members: [],
      declareDate: "",
      place: "",

      sigHead: "",
      sigOwner: "",
      sigGuardian: "",
      sigDeclarer: "",
      extraNote: ""
    };

    function sanitize(s){ return (s ?? "").toString().replace(/[<>]/g, ""); }
    function digitsOnly(s){ return (s ?? "").toString().replace(/\D/g, "").slice(0, 12); }

    function todayDDMMYYYY(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    // ===== Validation helpers =====
    function clearFieldError(el){
      if(!el) return;
      el.classList.remove("invalid");
      const next = el.nextElementSibling;
      if(next && next.classList.contains("fieldError")) next.remove();
    }

    function setFieldError(el, msg){
      if(!el) return;
      el.classList.add("invalid");
      const next = el.nextElementSibling;
      if(next && next.classList.contains("fieldError")) next.remove();

      const div = document.createElement("div");
      div.className = "fieldError";
      div.textContent = msg;
      el.insertAdjacentElement("afterend", div);
    }

    function isValidEmail(s){
      const v = (s || "").trim();
      if(!v) return true;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }

    function parseDDMMYYYY(s){
      const v = (s || "").trim();
      if(!v) return null;
      const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(v);
      if(!m) return null;
      const dd = Number(m[1]), mm = Number(m[2]), yyyy = Number(m[3]);
      if(mm < 1 || mm > 12) return null;
      const maxDay = new Date(yyyy, mm, 0).getDate();
      if(dd < 1 || dd > maxDay) return null;
      return new Date(yyyy, mm - 1, dd);
    }

    function isValidPhone(s){
      const raw = (s ?? "").toString().trim();
      if(raw === "") return true;
      const v = digitsOnly(raw);
      return v.length >= 9 && v.length <= 11;
    }

    function validateAll(showAlert = true){
      syncFromInputs();

      const errors = [];
      const first = { el: null };

      const req = (id, msg, testFn) => {
        const el = $(id);
        clearFieldError(el);
        const val = (el?.value || "").trim();

        let ok = true;
        if(testFn) ok = testFn(val);
        else ok = !!val;

        if(!ok){
          setFieldError(el, msg);
          errors.push(msg);
          if(!first.el) first.el = el;
        }
      };

      req("agency", "K√≠nh g·ª≠i (1) kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
      req("fullName", "H·ªç t√™n khai sinh (1) kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
      req("dob", "Ng√†y sinh (dd/mm/yyyy) kh√¥ng h·ª£p l·ªá.", (v) => !!parseDDMMYYYY(v));
      req("gender", "Vui l√≤ng ch·ªçn gi·ªõi t√≠nh.");
      req("idNumber", "S·ªë ƒë·ªãnh danh c√° nh√¢n ph·∫£i ƒë·ªß 12 s·ªë.", (v) => digitsOnly(v).length === 12);
      req("phone", "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (9‚Äì11 s·ªë).", (v) => isValidPhone(v));

      const emailEl = $("email");
      clearFieldError(emailEl);
      if(emailEl && !isValidEmail(emailEl.value)){
        setFieldError(emailEl, "Email kh√¥ng h·ª£p l·ªá.");
        errors.push("Email kh√¥ng h·ª£p l·ªá.");
        if(!first.el) first.el = emailEl;
      }

      req("requestContent", "N·ªôi dung ƒë·ªÅ ngh·ªã (10) kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
      req("declareDate", "Ng√†y l·∫≠p t·ªù khai kh√¥ng h·ª£p l·ªá (dd/mm/yyyy).", (v)=> !!parseDDMMYYYY(v));
      req("place", "ƒê·ªãa danh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
      req("sigDeclarer", "Ng∆∞·ªùi k√™ khai (t√™n) kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");

      if(state.requestType === "tamtru"){
        req("tempAddress", "ƒê·ªãa ch·ªâ t·∫°m tr√∫ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
        req("fromDate", "T·ª´ ng√†y kh√¥ng h·ª£p l·ªá (dd/mm/yyyy).", (v)=> !!parseDDMMYYYY(v));

        const toEl = $("toDate");
        clearFieldError(toEl);
        const fromD = parseDDMMYYYY($("fromDate").value);
        const toD = parseDDMMYYYY(toEl.value);

        if(toEl.value.trim()){
          if(!toD){
            setFieldError(toEl, "ƒê·∫øn ng√†y kh√¥ng h·ª£p l·ªá (dd/mm/yyyy).");
            errors.push("ƒê·∫øn ng√†y kh√¥ng h·ª£p l·ªá.");
            if(!first.el) first.el = toEl;
          }else if(fromD && toD < fromD){
            setFieldError(toEl, "ƒê·∫øn ng√†y ph·∫£i l·ªõn h∆°n ho·∫∑c b·∫±ng T·ª´ ng√†y.");
            errors.push("ƒê·∫øn ng√†y ph·∫£i >= T·ª´ ng√†y.");
            if(!first.el) first.el = toEl;
          }
        }
      }

      const rows = [...document.querySelectorAll("#membersTable tbody tr")];
      rows.forEach((tr) => {
        const nameEl = tr.querySelector(".m-name");
        const dobEl  = tr.querySelector(".m-dob");
        const idEl   = tr.querySelector(".m-id");

        [nameEl, dobEl, idEl].forEach(clearFieldError);

        const name = (nameEl?.value || "").trim();
        const dob  = (dobEl?.value || "").trim();
        const id   = digitsOnly(idEl?.value || "");

        const any = !!(name || dob || id);
        if(any){
          if(!name){
            setFieldError(nameEl, "Thi·∫øu h·ªç t√™n th√†nh vi√™n.");
            errors.push("Thi·∫øu h·ªç t√™n th√†nh vi√™n.");
            if(!first.el) first.el = nameEl;
          }
          if(dob && !parseDDMMYYYY(dob)){
            setFieldError(dobEl, "Ng√†y sinh th√†nh vi√™n kh√¥ng h·ª£p l·ªá.");
            errors.push("Ng√†y sinh th√†nh vi√™n kh√¥ng h·ª£p l·ªá.");
            if(!first.el) first.el = dobEl;
          }
          if(id && id.length !== 12){
            setFieldError(idEl, "S·ªë ƒë·ªãnh danh th√†nh vi√™n ph·∫£i ƒë·ªß 12 s·ªë.");
            errors.push("S·ªë ƒë·ªãnh danh th√†nh vi√™n ph·∫£i ƒë·ªß 12 s·ªë.");
            if(!first.el) first.el = idEl;
          }
          if(idEl) idEl.value = id;
        }
      });

      if(errors.length){
        if(showAlert){
          alert("Vui l√≤ng ki·ªÉm tra l·∫°i c√°c tr∆∞·ªùng ƒëang b·ªã l·ªói (b√¥i ƒë·ªè) tr∆∞·ªõc khi in/l∆∞u PDF.");
          if(first.el){
            first.el.scrollIntoView({ behavior:"smooth", block:"center" });
            first.el.focus();
          }
        }
        return false;
      }

      return true;
    }

    // ===== Preview scale (responsive) =====
    function fitA4Preview(){
      const vp = $("a4Viewport");
      const a4 = $("a4");
      if(!vp || !a4) return;

      a4.style.transform = "none";

      const vpW = Math.max(1, vp.clientWidth - 20);
      const a4W = Math.max(1, a4.getBoundingClientRect().width);

      const scale = Math.min(1, vpW / a4W);
      a4.style.transform = `scale(${scale})`;
    }

    function lineFill(value, minWidthMm = 90){
      const v = sanitize(value).trim();
      const style = (minWidthMm && Number(minWidthMm) > 0) ? `style="min-width:${minWidthMm}mm"` : "";
      return `
        <span class="line ${v ? "filled" : ""}" ${style}>
          ${v ? `<span class="fill">${v}</span>` : "&nbsp;"}
        </span>
      `;
    }

    function renderBoxes(idStr){
      const d = digitsOnly(idStr);
      const arr = d.split("");
      let html = `<span class="boxes">`;
      for(let i=0;i<1;i++){
        html += `<span class="box box1">${arr[i] ? sanitize(arr[i]) : ""}</span>`;
      }
      for(let i=1;i<12;i++){
        html += `<span class="box">${arr[i] ? sanitize(arr[i]) : ""}</span>`;
      }
      html += `</span>`;
      return html;
    }

    function buildSuggestedContent() {
      const type = state.requestType;
      if (type === "khac") return "";

      if (type === "tamtru") {
        const headName2 = sanitize(state.householdHeadName).trim();
        const addr = sanitize(state.tempAddress).trim();

        let addrFull = "";
        if (addr) {
          addrFull = headName2 ? `Nh√† tr·ªç ${headName2}, ${addr}` : `${addr}`;
        }

        const from = sanitize(state.fromDate).trim();
        const to = sanitize(state.toDate).trim();
        const reason = sanitize(state.reason).trim();

        let s = "ƒê·ªÅ ngh·ªã ƒëƒÉng k√Ω t·∫°m tr√∫";
        if (addrFull) s += ` t·∫°i: ${addrFull}.`;
        if (from) s += ` Th·ªùi gian t·∫°m tr√∫: t·ª´ ng√†y ${from}`;
        if (to) s += ` ƒë·∫øn ng√†y ${to}.`;
        else if (from) s += ".";
        if (reason) s += ` L√Ω do: ${reason}.`;

        return s;
      }

      if (type === "dieuchinh") {
        return "ƒê·ªÅ ngh·ªã ƒëi·ªÅu ch·ªânh/c·∫≠p nh·∫≠t th√¥ng tin c∆∞ tr√∫ trong C∆° s·ªü d·ªØ li·ªáu v·ªÅ c∆∞ tr√∫ (n√™u r√µ n·ªôi dung c·∫ßn ƒëi·ªÅu ch·ªânh).";
      }

      if (type === "xacnhan") {
        return "ƒê·ªÅ ngh·ªã x√°c nh·∫≠n th√¥ng tin v·ªÅ c∆∞ tr√∫ (n√™u r√µ n·ªôi dung c·∫ßn x√°c nh·∫≠n).";
      }

      return "";
    }

    function syncFromInputs(){
      state.agency = $("agency").value;

      state.fullName = $("fullName").value;
      state.dob = $("dob").value;
      state.gender = $("gender").value;

      state.idNumber = digitsOnly($("idNumber").value);
      $("idNumber").value = state.idNumber;

      state.phone = $("phone").value;
      state.email = $("email").value;

      state.householdHeadName = $("householdHeadName").value;
      state.relationToHead = $("relationToHead").value;

      state.headIdNumber = digitsOnly($("headIdNumber").value);
      $("headIdNumber").value = state.headIdNumber;

      state.requestType = $("requestType").value;

      state.tempAddress = $("tempAddress").value;
      state.fromDate = $("fromDate").value;
      state.toDate = $("toDate").value;
      state.reason = $("reason").value;

      // ‚úÖ AUTO SUGGEST (ONLY if user hasn't manually edited requestContent)
      const rc = $("requestContent");
      const suggested = buildSuggestedContent();
      if(state.requestType !== "khac"){
        const isManual = rc.dataset.manual === "1";
        if(!isManual || rc.value.trim() === ""){
          rc.value = suggested || rc.value;
          rc.dataset.manual = ""; // keep auto mode
        }
      }
      state.requestContent = rc.value;

      state.declareDate = $("declareDate").value;
      state.place = $("place").value;

      state.sigHead = $("sigHead").value;
      state.sigOwner = $("sigOwner").value;
      state.sigGuardian = $("sigGuardian").value;

      // ‚úÖ sigDeclarer lu√¥n = fullName
      $("sigDeclarer").value = state.fullName || "";
      state.sigDeclarer = $("sigDeclarer").value;

      state.extraNote = $("extraNote").value;

      const rows = [...document.querySelectorAll("#membersTable tbody tr")];
      state.members = rows.map((tr) => {
        const get = (sel) => tr.querySelector(sel).value;
        return {
          name: get(".m-name"),
          dob: get(".m-dob"),
          gender: get(".m-gender"),
          id: digitsOnly(get(".m-id")),
          relation: get(".m-rel")
        };
      });
      rows.forEach((tr, idx) => tr.querySelector(".m-id").value = state.members[idx].id);
    }

function renderMembersPrint(){
  const BASE_ROWS = 6; // m·∫∑c ƒë·ªãnh 6 d√≤ng
  const MAX_ROWS  = 8; // t·ªëi ƒëa 8 d√≤ng

  // ‚úÖ ch·ªâ l·∫•y nh·ªØng d√≤ng c√≥ nh·∫≠p d·ªØ li·ªáu (b·ªè d√≤ng tr·ªëng)
  const filled = (state.members || []).filter(m => {
    const name = (m?.name || "").trim();
    const dob = (m?.dob || "").trim();
    const gender = (m?.gender || "").trim();
    const id = (m?.id || "").trim();
    const relation = (m?.relation || "").trim();
    return !!(name || dob || gender || id || relation);
  });

  // ‚úÖ s·ªë d√≤ng c·∫ßn in: √≠t nh·∫•t 6, tƒÉng theo s·ªë ng∆∞·ªùi, nh∆∞ng kh√¥ng v∆∞·ª£t 8
  const totalRows = Math.min(MAX_ROWS, Math.max(BASE_ROWS, filled.length));

  // ‚úÖ ch·ªâ in t·ªëi ƒëa 8 ng∆∞·ªùi
  const rowsToPrint = filled.slice(0, totalRows);

  const htmlRows = rowsToPrint.map((m, i) => `
    <tr>
      <td style="text-align:center">${i+1}</td>
      <td>${sanitize(m.name||"")}</td>
      <td style="text-align:center">${sanitize(m.dob||"")}</td>
      <td style="text-align:center">${sanitize(m.gender||"")}</td>
      <td style="text-align:center">${sanitize(m.id||"")}</td>
      <td>${sanitize(m.relation||"")}</td>
    </tr>
  `).join("");

  const blanksCount = totalRows - rowsToPrint.length;

  const blankRows = Array.from({length: blanksCount}, (_, k) => `
    <tr>
      <td style="text-align:center">${rowsToPrint.length + k + 1}</td>
      <td></td><td></td><td></td><td></td><td></td>
    </tr>
  `).join("");

  return htmlRows + blankRows;
}


    function renderDeclareDMY(dateStr){
      const v = (dateStr || "").trim();
      const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(v);
      const dd = m ? m[1] : ".....";
      const mm = m ? m[2] : ".....";
      const yyyy = m ? m[3] : ".......";
      return `<span class="ddmmyy">....., ng√†y ${dd} th√°ng ${mm} nƒÉm ${yyyy}</span>`;
    }

    function buildCT01Html(){
      const agency = sanitize(state.agency).trim();
      const fullName = sanitize(state.fullName).trim();
      const dob = sanitize(state.dob).trim();
      const gender = sanitize(state.gender).trim();
      const phone = sanitize(state.phone).trim();
      const email = sanitize(state.email).trim();
      const headName = sanitize(state.householdHeadName).trim();
      const rel = sanitize(state.relationToHead).trim();
      const content = sanitize(state.requestContent).trim();
      const sigHead = sanitize(state.sigHead).trim();
      const sigOwner = sanitize(state.sigOwner).trim();
      const sigGuardian = sanitize(state.sigGuardian).trim();
      const sigDeclarer = sanitize(state.sigDeclarer).trim();
      const declareDMY = renderDeclareDMY(state.declareDate);

      return `
        <div class="center">
          <div style="font-size:14pt; font-weight:700">C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</div>
          <div style="margin-top:2mm;font-size:14pt; font-weight:700">ƒê·ªôc l·∫≠p ‚Äì T·ª± do ‚Äì H·∫°nh ph√∫c
            <hr style="width: 180px; line:2px;">
          </div>
          <div style="margin-top:2mm; font-weight:700; font-size:13pt">T·ªú KHAI THAY ƒê·ªîI TH√îNG TIN C∆Ø TR√ö</div>
        </div>

        <div style="margin-top:5mm; font-size:13pt">
          <div class="printLine" style="justify-content:center;">
            <span class="lbl">K√≠nh g·ª≠i (1):</span>
            ${lineFill(agency, 0)}
          </div>

          <div class="printLine">
            <span class="lbl">1. H·ªç, ch·ªØ ƒë·ªám v√† t√™n khai sinh:</span>
            ${lineFill(fullName, 0)}
          </div>

          <div class="printGrid2">
            <div class="printLine" style="margin-top:0">
              <span class="lbl">2. Ng√†y, th√°ng, nƒÉm sinh:</span>
              ${lineFill(dob, 0)}
            </div>
            <div class="printLine" style="margin-top:0">
              <span class="lbl">3. Gi·ªõi t√≠nh:</span>
              ${lineFill(gender, 0)}
            </div>
          </div>

          <div class="printLine cccd">
            <span class="lbl">4. S·ªë ƒë·ªãnh danh c√° nh√¢n:</span>
            <span>${renderBoxes(state.idNumber)}</span>
          </div>

          <div class="printGrid2">
            <div class="printLine" style="margin-top:0">
              <span class="lbl">5. S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá:</span>
              ${lineFill(phone, 0)}
            </div>
            <div class="printLine" style="margin-top:0">
              <span class="lbl">6. Email:</span>
              ${lineFill(email, 0)}
            </div>
          </div>

          <div class="printLine">
            <span class="lbl">7. H·ªç, ch·ªØ ƒë·ªám v√† t√™n ch·ªß h·ªô:</span>
            ${lineFill(headName, 0)}
          </div>

          <div class="printLine">
            <span class="lbl">8. M·ªëi quan h·ªá v·ªõi ch·ªß h·ªô:</span>
            ${lineFill(rel, 0)}
          </div>

          <div class="printLine cccd">
            <span class="lbl">9. S·ªë ƒë·ªãnh danh c√° nh√¢n c·ªßa ch·ªß h·ªô:</span>
            <span>${renderBoxes(state.headIdNumber)}</span>
          </div>

          <div class="printPara10">
            <span class="lbl">10. N·ªôi dung ƒë·ªÅ ngh·ªã (2): </span>
            ${
              content
                ? `<span class="txt">${sanitize(content)}</span>`
                : `<span class="txt empty">&nbsp;</span>`
            }
          </div>


          <div style="margin-top:3mm">
            11. Nh·ªØng th√†nh vi√™n trong h·ªô gia ƒë√¨nh c√πng thay ƒë·ªïi:
          </div>

          <table class="printTable">
            <thead>
              <tr>
                <th style="width:10mm">TT</th>
                <th style="width:50mm">H·ªç, ch·ªØ ƒë·ªám v√† t√™n</th>
                <th style="width:30mm">Ng√†y, th√°ng, nƒÉm sinh</th>
                <th style="width:20mm">Gi·ªõi t√≠nh</th>
                <th style="width:45mm">S·ªë ƒë·ªãnh danh c√° nh√¢n</th>
                <th style="width:35mm">M·ªëi quan h·ªá v·ªõi ch·ªß h·ªô</th>
              </tr>
            </thead>
            <tbody>
              ${renderMembersPrint()}
            </tbody>
          </table>

          <div class="sigRow">
            <div class="sig">
              ${declareDMY}
              <div class="cap">√ù KI·∫æN C·ª¶A CH·ª¶ H·ªò (3)</div>
              <div class="note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
              <div class="fillName">${sigHead || ""}</div>
            </div>
            <div class="sig">
              ${declareDMY}
              <div class="cap">√ù KI·∫æN C·ª¶A CH·ª¶ S·ªû H·ªÆU<br/>CH·ªñ ·ªû H·ª¢P PH√ÅP (4)</div>
              <div class="note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
              <div class="fillName">${sigOwner || ""}</div>
            </div>
            <div class="sig">
              ${declareDMY}
              <div class="cap">√ù KI·∫æN C·ª¶A CHA, M·∫∏<br/>NG∆Ø·ªúI GI√ÅM H·ªò (5)</div>
              <div class="note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
              <div class="fillName">${sigGuardian || ""}</div>
            </div>
            <div class="sig">
              ${declareDMY}
              <div class="cap">NG∆Ø·ªúI K√ä KHAI (6)</div>
              <div class="note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
              <div class="fillName">${sigDeclarer || ""}</div>
            </div>
          </div>
        </div>
      `;
    }

    // ‚úÖ nh·∫≠n d·ªØ li·ªáu t·ª´ trang qu√©t QR (index)
    (function hydrateFromPrefill(){
      const key = "ct01_prefill_v1";
      const raw = sessionStorage.getItem(key);
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        Object.assign(state, obj || {});
        sessionStorage.removeItem(key);
        applyStateToInputs(true); // ‚úÖ fromPrefill=true => kh√¥ng kh√≥a manual
      }catch(e){}
    })();

    function renderPreview(){
      syncFromInputs();
      const html = buildCT01Html();
      $("a4").innerHTML = html;
      $("a4Print").innerHTML = html;
      requestAnimationFrame(fitA4Preview);
    }

    function addMemberRow(data={}){
      const tbody = document.querySelector("#membersTable tbody");
      const idx = tbody.querySelectorAll("tr").length + 1;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="text-align:center; font-weight:800">${idx}</td>
        <td><input class="m-name" placeholder="H·ªç t√™n" value="${sanitize(data.name||"")}" /></td>
        <td><input class="m-dob" placeholder="dd/mm/yyyy" value="${sanitize(data.dob||"")}" /></td>
        <td><input class="m-gender" placeholder="Nam/N·ªØ" value="${sanitize(data.gender||"")}" /></td>
        <td><input class="m-id" maxlength="12" inputmode="numeric" placeholder="12 s·ªë" value="${sanitize(data.id||"")}" /></td>
        <td><input class="m-rel" placeholder="Quan h·ªá v·ªõi ch·ªß h·ªô" value="${sanitize(data.relation||"")}" /></td>
        <td style="text-align:center">
          <button class="btn danger" type="button" style="padding:8px 10px; border-radius:10px">‚úñ</button>
        </td>
      `;
      tr.querySelector("button").addEventListener("click", () => {
        tr.remove();
        reindexMembers();
        validateAll(false);
        renderPreview();
      });

      tr.querySelectorAll("input").forEach(inp => {
        inp.addEventListener("input", () => {
          if(inp.classList.contains("m-id")) inp.value = digitsOnly(inp.value);
        });
        inp.addEventListener("change", () => {
          validateAll(false);
          renderPreview();
        });
      });

      tbody.appendChild(tr);
    }

    function reindexMembers(){
      const rows = [...document.querySelectorAll("#membersTable tbody tr")];
      rows.forEach((tr, i) => tr.children[0].textContent = (i+1));
    }

    function downloadJson(){
      syncFromInputs();
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ct01_data.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function loadJsonFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          Object.assign(state, obj || {});
          applyStateToInputs(false); // JSON load => gi·ªØ manual theo requestType
          ensureDefaults();
          validateAll(false);
          renderPreview();
        }catch(e){
          alert("File JSON kh√¥ng h·ª£p l·ªá.");
        }
      };
      reader.readAsText(file);
    }

    function ensureDefaults(){
      if(!$("declareDate").value.trim()){
        $("declareDate").value = todayDDMMYYYY();
      }
      if(!$("place").value.trim()){
        $("place").value = "TP. H·ªì Ch√≠ Minh";
      }
      $("sigDeclarer").value = $("fullName").value || "";

      if($("requestType").value === "tamtru" && !$("fromDate").value.trim()){
        $("fromDate").value = todayDDMMYYYY();
      }
    }

    // ‚úÖ fromPrefill: n·∫øu true => kh√¥ng kh√≥a manual ƒë·ªÉ auto-suggest ho·∫°t ƒë·ªông
    function applyStateToInputs(fromPrefill=false){
      $("agency").value = state.agency || "";
      $("fullName").value = state.fullName || "";
      $("dob").value = state.dob || "";
      $("gender").value = state.gender || "";
      $("idNumber").value = state.idNumber || "";
      $("phone").value = state.phone || "";
      $("email").value = state.email || "";

      $("householdHeadName").value = state.householdHeadName || "";
      $("relationToHead").value = state.relationToHead || "";
      $("headIdNumber").value = state.headIdNumber || "";
      $("requestType").value = state.requestType || "tamtru";

      $("tempAddress").value = state.tempAddress || "";
      $("fromDate").value = state.fromDate || "";
      $("toDate").value = state.toDate || "";
      $("reason").value = state.reason || "";

      // requestContent: n·∫øu prefill => cho auto mode (manual = "")
      $("requestContent").value = state.requestContent || "";
      if(fromPrefill){
        $("requestContent").dataset.manual = "";
      }else{
        $("requestContent").dataset.manual = (state.requestType === "khac") ? "1" : "";
      }

      $("declareDate").value = state.declareDate || "";
      $("place").value = state.place || "";

      $("sigHead").value = state.sigHead || "";
      $("sigOwner").value = state.sigOwner || "";
      $("sigGuardian").value = state.sigGuardian || "";

      $("sigDeclarer").value = state.fullName || "";
      $("extraNote").value = state.extraNote || "";

      const tbody = document.querySelector("#membersTable tbody");
      tbody.innerHTML = "";
      (state.members || []).forEach(m => addMemberRow(m));
    }

    function resetAll(){
      document.querySelectorAll("input, textarea, select").forEach(el => {
        clearFieldError(el);
        if(el.id === "requestType") el.value = "tamtru";
        else if(el.id === "agency") el.value = "C√¥ng an ph∆∞·ªùng B√¨nh C∆°, TP. H·ªì Ch√≠ Minh";
        else el.value = "";
      });

      $("requestContent").dataset.manual = ""; // ‚úÖ reset v·ªÅ auto
      document.querySelector("#membersTable tbody").innerHTML = "";

      $("declareDate").value = todayDDMMYYYY();
      $("place").value = "TP. H·ªì Ch√≠ Minh";
      $("fromDate").value = todayDDMMYYYY();
      $("sigDeclarer").value = $("fullName").value || "";

      renderPreview();
    }

    // ===== Events =====

    // ‚úÖ fullName ƒë·ªïi -> sigDeclarer ƒë·ªïi ngay
    $("fullName").addEventListener("input", () => {
      $("sigDeclarer").value = $("fullName").value || "";
      renderPreview();
    });

    // ‚úÖ user g√µ tr·ª±c ti·∫øp √¥ (10) => kh√≥a auto-suggest
    $("requestContent").addEventListener("input", () => {
      $("requestContent").dataset.manual = "1";
    });

    // ‚úÖ c√°c field builder: g√µ l√† update n·ªôi dung ƒë·ªÅ ngh·ªã ngay (n·∫øu ch∆∞a manual)
    ["householdHeadName","tempAddress","fromDate","toDate","reason","requestType"].forEach(id => {
      $(id).addEventListener("input", () => {
        ensureDefaults();
        validateAll(false);
        renderPreview();
      });
      $(id).addEventListener("change", () => {
        ensureDefaults();
        validateAll(false);
        renderPreview();
      });
    });

    // C√°c field kh√°c: change ƒë·ªÉ validate + render
    document.querySelectorAll("input, select, textarea").forEach(el => {
      el.addEventListener("change", () => {
        ensureDefaults();
        validateAll(false);
        renderPreview();
      });
    });

    $("btnAddMember").addEventListener("click", () => { addMemberRow({}); validateAll(false); renderPreview(); });

    $("btnPreview").addEventListener("click", () => {
      ensureDefaults();
      validateAll(false);
      renderPreview();
    });

    $("btnPrint").addEventListener("click", () => {
      ensureDefaults();
      if(!validateAll(true)) return;
      renderPreview();
      window.print();
    });

    $("btnDownloadJson").addEventListener("click", downloadJson);

    $("btnLoadJson").addEventListener("click", () => $("jsonFile").click());
    $("jsonFile").addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if(f) loadJsonFile(f);
      e.target.value = "";
    });

    $("btnReset").addEventListener("click", () => {
      if(confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu ƒëang nh·∫≠p?")) resetAll();
    });

    window.addEventListener("resize", () => requestAnimationFrame(fitA4Preview));

    // ‚úÖ init defaults + first render
    ensureDefaults();
    renderPreview();
    validateAll(false);
  </script>
</body>
</html>
