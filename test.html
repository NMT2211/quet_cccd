<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qu√©t QR CCCD (Native) + Chuy·ªÉn ƒë·ªïi ƒë·ªãa ch·ªâ</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --muted:#9fb0d0; --text:#e7efff;
      --line: rgba(255,255,255,.10);
      --btn:#2b6cff; --btn2:#16a34a; --danger:#ef4444; --warn:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);padding:24px}
    .wrap{max-width:1100px;margin:0 auto;display:grid;gap:16px}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,textarea,select{width:100%;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--text);padding:10px 12px;outline:none}
    textarea{min-height:90px;resize:vertical}
    .btn{cursor:pointer;border:0;padding:10px 12px;border-radius:12px;color:#fff;font-weight:650;background:var(--btn)}
    .btn.secondary{background:rgba(255,255,255,.10);border:1px solid var(--line)}
    .btn.ok{background:var(--btn2)}
    .btn.danger{background:var(--danger)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .status{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.5}
    .error{color:var(--danger)}
    .warn{color:var(--warn)}
    .oktxt{color:#86efac}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:10px;padding:10px 0;border-top:1px dashed var(--line)}
    .kv:first-child{border-top:0}
    .k{color:var(--muted);font-size:12px}
    .v{font-weight:650}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    video{width:100%;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.25)}
    canvas{display:none}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="row">
      <div>
        <div style="font-size:18px;font-weight:800">Qu√©t QR CCCD (Native) ‚Üí Parse + Chuy·ªÉn ƒë·ªïi ƒë·ªãa ch·ªâ</div>
        <div class="status">
          D√πng <span class="mono">BarcodeDetector</span>. N·∫øu tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£, b·∫°n v·∫´n d√°n chu·ªói QR th·ªß c√¥ng.
        </div>
      </div>
      <div id="support" class="status"></div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="row">
          <div style="font-weight:800">üì∑ Qu√©t QR (kh√¥ng th∆∞ vi·ªán)</div>
          <div style="display:flex;gap:10px">
            <button class="btn" id="btnStart">B·∫Øt ƒë·∫ßu</button>
            <button class="btn secondary" id="btnStop" disabled>D·ª´ng</button>
          </div>
        </div>

        <div style="height:12px"></div>
        <video id="video" playsinline muted></video>
        <canvas id="canvas"></canvas>

        <div class="status" id="scanStatus">Tr·∫°ng th√°i: <b>Ch∆∞a qu√©t</b></div>

        <label>D√°n chu·ªói QR th·ªß c√¥ng</label>
        <textarea id="rawInput" placeholder='034205011440|---|Nguy·ªÖn Minh Tu·∫•n|22082005|Nam|T·ªï 4B, Kp 1, H·ªôi Nghƒ©a, Th·ªã x√£ T√¢n Uy√™n, B√¨nh D∆∞∆°ng|19042021'></textarea>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn secondary" id="btnParse">Parse</button>
          <button class="btn danger" id="btnClear">X√≥a</button>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div style="font-weight:800">ü™™ D·ªØ li·ªáu CCCD</div>
        <div style="height:10px"></div>
        <div class="kv"><div class="k">S·ªë CCCD</div><div class="v mono" id="cccd">‚Äî</div></div>
        <div class="kv"><div class="k">H·ªç t√™n</div><div class="v" id="name">‚Äî</div></div>
        <div class="kv"><div class="k">Ng√†y sinh</div><div class="v" id="dob">‚Äî</div></div>
        <div class="kv"><div class="k">Gi·ªõi t√≠nh</div><div class="v" id="gender">‚Äî</div></div>
        <div class="kv"><div class="k">ƒê·ªãa ch·ªâ (c≈©)</div><div class="v" id="oldAddr">‚Äî</div></div>
        <div class="kv"><div class="k">Ng√†y c·∫•p</div><div class="v" id="issue">‚Äî</div></div>

        <hr style="border:0;border-top:1px solid var(--line);margin:14px 0" />

        <div style="font-weight:800">üîÅ Chuy·ªÉn ƒë·ªïi ƒë·ªãa ch·ªâ</div>
        <div class="status">POST <span class="mono">https://tinhthanhpho.com/api/v1/convert/address</span> (Bearer API key)</div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
          <div>
            <label>API Key (Bearer)</label>
            <input id="apiKey" placeholder="Bearer token..." />
          </div>
          <div>
            <label>Ch·∫ø ƒë·ªô</label>
            <select id="mode">
              <option value="smart" selected>T·ª± d√≤ m√£ t·ª´ ƒë·ªãa ch·ªâ</option>
              <option value="manual">Nh·∫≠p m√£ tay</option>
            </select>
          </div>
        </div>

        <div id="manualCodes" style="display:none; margin-top:10px">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div><label>provinceCode</label><input id="provinceCode" placeholder="VD: 74" /></div>
            <div><label>districtCode</label><input id="districtCode" placeholder="..." /></div>
            <div><label>wardCode</label><input id="wardCode" placeholder="..." /></div>
            <div><label>streetAddress</label><input id="streetAddress" placeholder="T·ªï 4B, Kp 1" /></div>
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn ok" id="btnConvert">Chuy·ªÉn ƒë·ªïi</button>
          <button class="btn secondary" id="btnGuess">D√≤ m√£ (log)</button>
        </div>

        <div class="status" id="convertStatus" style="margin-top:10px">‚Äî</div>

        <label>ƒê·ªãa ch·ªâ m·ªõi</label>
        <textarea id="newAddr" readonly></textarea>

        <label>Log</label>
        <textarea id="log" readonly class="mono"></textarea>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const video = $("video");
  const canvas = $("canvas");
  const ctx = canvas.getContext("2d", { willReadFrequently: true });

  let stream = null;
  let detector = null;
  let rafId = null;
  let lastText = "";
  let currentData = null;

  // ===== UI helpers
  function logLine(s){ $("log").value += ( $("log").value ? "\n" : "" ) + s; $("log").scrollTop = $("log").scrollHeight; }
  function setScanStatus(html){ $("scanStatus").innerHTML = `Tr·∫°ng th√°i: ${html}`; }
  function setConvertStatus(html){ $("convertStatus").innerHTML = html; }
  function fmtDDMMYYYY(s){
    if (!s) return "‚Äî";
    const t = (""+s).trim();
    if (/^\d{8}$/.test(t)) return `${t.slice(0,2)}/${t.slice(2,4)}/${t.slice(4,8)}`;
    return t;
  }

  // ===== CCCD parse
  function normalizeQR(raw){ return (raw||"").trim().replace(/\|\s*---\s*\|/g, "|"); }
  function parseQR(raw){
    const s = normalizeQR(raw);
    const parts = s.split("|").map(x => (x||"").trim()).filter(Boolean);
    if (parts.length < 6) throw new Error("Chu·ªói QR kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (c·∫ßn t·ªëi thi·ªÉu 6 tr∆∞·ªùng).");
    return { cccd: parts[0], name: parts[1], dob: parts[2], gender: parts[3], address: parts[4], issue: parts[5] };
  }
  function fillInfo(d){
    $("cccd").textContent = d?.cccd || "‚Äî";
    $("name").textContent = d?.name || "‚Äî";
    $("dob").textContent = fmtDDMMYYYY(d?.dob);
    $("gender").textContent = d?.gender || "‚Äî";
    $("oldAddr").textContent = d?.address || "‚Äî";
    $("issue").textContent = fmtDDMMYYYY(d?.issue);
  }

  // ===== Address split + soft match
  function splitAddress(addr){
    const chunks = (addr||"").trim().split(",").map(x=>x.trim()).filter(Boolean);
    if (chunks.length < 3) return { street:(addr||"").trim(), wardName:"", districtName:"", provinceName:"" };
    return { street: chunks.slice(0,-3).join(", ").trim(), wardName: chunks.at(-3), districtName: chunks.at(-2), provinceName: chunks.at(-1) };
  }
  function stripDiacritics(s){
    return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/ƒë/g,"d").replace(/ƒê/g,"D");
  }
  function normName(s){
    return stripDiacritics(s).toLowerCase()
      .replace(/\b(thanh pho|thi xa|quan|huyen|thi tran|xa|phuong|tp)\b/g,"")
      .replace(/[^\w\s]/g," ")
      .replace(/\s+/g," ").trim();
  }
  function bestMatch(list, target){
    if (!list?.length) return null;
    const t = normName(target);
    let f = list.find(x => normName(x.name) === t);
    if (f) return f;
    f = list.find(x => normName(x.name).includes(t) || t.includes(normName(x.name)));
    if (f) return f;
    return null;
  }

  // ===== API tinhthanhpho.com
  const BASE = "https://tinhthanhpho.com/api/v1";
  async function apiGET(path, params){
    const url = new URL(BASE + path);
    Object.entries(params||{}).forEach(([k,v]) => { if (v!==undefined && v!==null && (""+v).length) url.searchParams.set(k,v); });
    logLine("GET " + url.toString());
    const res = await fetch(url.toString(), { headers: { "Accept":"application/json" }});
    const data = await res.json().catch(()=>({}));
    logLine("‚Ü≥ " + res.status + " " + JSON.stringify(data).slice(0,1000));
    if (!res.ok) throw new Error("GET l·ªói HTTP " + res.status);
    if (data?.success === false) throw new Error(data.message || "API success=false");
    return data;
  }
  async function apiPOST(path, body, apiKey){
    const url = BASE + path;
    logLine("POST " + url);
    logLine("Body: " + JSON.stringify(body));
    const res = await fetch(url, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Accept":"application/json",
        "Authorization":"Bearer " + apiKey
      },
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(()=>({}));
    logLine("‚Ü≥ " + res.status + " " + JSON.stringify(data).slice(0,1500));
    if (!res.ok) throw new Error("POST l·ªói HTTP " + res.status + (data?.message?(": "+data.message):""));
    if (data?.success === false) throw new Error(data.message || "API success=false");
    return data;
  }

  async function guessCodesFromAddress(addr){
    const { street, wardName, districtName, provinceName } = splitAddress(addr);
    if (!provinceName || !districtName || !wardName) throw new Error("ƒê·ªãa ch·ªâ thi·∫øu 3 c·ª•m cu·ªëi (x√£/huy·ªán/t·ªânh) ph√¢n t√°ch b·∫±ng d·∫•u ph·∫©y.");

    setConvertStatus(`ƒêang d√≤ m√£: <b>${provinceName}</b> / <b>${districtName}</b> / <b>${wardName}</b> ...`);

    const provRes = await apiGET("/provinces", { keyword: provinceName, limit: 20, page: 1 });
    const prov = bestMatch(provRes.data||[], provinceName) || (provRes.data||[])[0];
    if (!prov?.code) throw new Error("Kh√¥ng t√¨m th·∫•y provinceCode.");

    // IMPORTANT: fetch ALL districts then match (kh√¥ng d√πng keyword)
    const distRes = await apiGET(`/provinces/${encodeURIComponent(prov.code)}/districts`, { limit: 300, page: 1 });
    let dist = bestMatch(distRes.data||[], districtName);
    if (!dist) dist = bestMatch(distRes.data||[], districtName.replace(/th·ªã x√£/ig,"th√†nh ph·ªë"));
    if (!dist?.code) throw new Error("Kh√¥ng match ƒë∆∞·ª£c district.");

    // fetch ALL wards then match
    const wardRes = await apiGET(`/districts/${encodeURIComponent(dist.code)}/wards`, { limit: 500, page: 1 });
    let ward = bestMatch(wardRes.data||[], wardName);
    if (!ward) ward = bestMatch(wardRes.data||[], wardName.replace(/\b(x√£|ph∆∞·ªùng|th·ªã tr·∫•n)\b/ig,""));
    if (!ward?.code) throw new Error("Kh√¥ng match ƒë∆∞·ª£c ward.");

    return { provinceCode: prov.code, districtCode: dist.code, wardCode: ward.code, streetAddress: street || "" };
  }

  // ===== Native QR scan loop
  async function start(){
    if (!("BarcodeDetector" in window)) {
      setScanStatus(`<b class="warn">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ BarcodeDetector</b> ‚Ä¢ D√°n chu·ªói QR th·ªß c√¥ng.`);
      return;
    }

    detector = new BarcodeDetector({ formats: ["qr_code"] });

    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
      video.srcObject = stream;
      await video.play();

      $("btnStart").disabled = true;
      $("btnStop").disabled = false;
      setScanStatus(`<b class="oktxt">ƒêang qu√©t...</b> ƒê∆∞a QR v√†o camera.`);

      loop();
    } catch (e) {
      setScanStatus(`<b class="error">Kh√¥ng m·ªü ƒë∆∞·ª£c camera</b> ‚Ä¢ ${e.message}`);
    }
  }

  async function loop(){
    if (!video.videoWidth || !video.videoHeight) {
      rafId = requestAnimationFrame(loop);
      return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    try {
      const bitmap = await createImageBitmap(canvas);
      const codes = await detector.detect(bitmap);

      if (codes && codes.length) {
        const text = (codes[0].rawValue || "").trim();
        if (text && text !== lastText) {
          lastText = text;
          $("rawInput").value = text;
          setScanStatus(`<b class="oktxt">ƒê√£ qu√©t</b> ‚Ä¢ <span class="mono">${text}</span>`);

          try {
            const d = parseQR(text);
            currentData = d;
            fillInfo(d);
            setConvertStatus(`<span class="oktxt">Parse OK.</span> B·∫•m <b>Chuy·ªÉn ƒë·ªïi</b> ƒë·ªÉ l·∫•y ƒë·ªãa ch·ªâ m·ªõi.`);
          } catch (pe) {
            setConvertStatus(`<span class="error">L·ªói parse:</span> ${pe.message}`);
          }
        }
      }
    } catch (e) {
      // ignore detect errors
    }

    rafId = requestAnimationFrame(loop);
  }

  function stop(){
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    lastText = "";
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    $("btnStart").disabled = false;
    $("btnStop").disabled = true;
    setScanStatus("<b>ƒê√£ d·ª´ng</b>");
  }

  // ===== Events
  $("btnStart").addEventListener("click", start);
  $("btnStop").addEventListener("click", stop);

  $("btnParse").addEventListener("click", () => {
    try {
      const d = parseQR($("rawInput").value);
      currentData = d;
      fillInfo(d);
      setConvertStatus(`<span class="oktxt">Parse OK.</span> B·∫•m <b>Chuy·ªÉn ƒë·ªïi</b> ƒë·ªÉ l·∫•y ƒë·ªãa ch·ªâ m·ªõi.`);
    } catch (e) {
      setConvertStatus(`<span class="error">L·ªói:</span> ${e.message}`);
    }
  });

  $("btnClear").addEventListener("click", () => {
    $("rawInput").value = "";
    $("newAddr").value = "";
    $("log").value = "";
    currentData = null;
    fillInfo({});
    setScanStatus("<b>Ch∆∞a qu√©t</b>");
    setConvertStatus("‚Äî");
  });

  $("mode").addEventListener("change", (e) => {
    $("manualCodes").style.display = (e.target.value === "manual") ? "block" : "none";
  });

  $("btnGuess").addEventListener("click", async () => {
    try {
      $("log").value = "";
      const addr = currentData?.address || $("oldAddr").textContent;
      const codes = await guessCodesFromAddress(addr);
      logLine("‚úÖ Codes: " + JSON.stringify(codes));
      setConvertStatus(`<span class="oktxt">D√≤ m√£ OK.</span> province=<b>${codes.provinceCode}</b>, district=<b>${codes.districtCode}</b>, ward=<b>${codes.wardCode}</b>`);
    } catch (e) {
      setConvertStatus(`<span class="error">D√≤ m√£ l·ªói:</span> ${e.message}`);
    }
  });

  $("btnConvert").addEventListener("click", async () => {
    try {
      $("newAddr").value = "";
      $("log").value = "";

      const apiKey = ($("apiKey").value || "").trim();
      if (!apiKey) throw new Error("B·∫°n ch∆∞a nh·∫≠p API key.");
      if (!currentData?.address) throw new Error("Ch∆∞a c√≥ ƒë·ªãa ch·ªâ c≈©. H√£y qu√©t QR ho·∫∑c d√°n chu·ªói.");

      let payload;
      if ($("mode").value === "manual") {
        const provinceCode = ($("provinceCode").value||"").trim();
        const districtCode = ($("districtCode").value||"").trim();
        const wardCode = ($("wardCode").value||"").trim();
        const streetAddress = ($("streetAddress").value||"").trim();
        if (!provinceCode || !districtCode || !wardCode) throw new Error("Thi·∫øu m√£ province/district/ward.");
        payload = { provinceCode, districtCode, wardCode, streetAddress };
      } else {
        payload = await guessCodesFromAddress(currentData.address);
      }

      setConvertStatus("<b>ƒêang g·ªçi API chuy·ªÉn ƒë·ªïi...</b>");
      const res = await apiPOST("/convert/address", payload, apiKey);

      const newFull = res?.data?.new?.fullAddress || "";
      const notes = res?.data?.mergeInfo?.notes || "";
      if (!newFull) {
        $("newAddr").value = JSON.stringify(res, null, 2);
        setConvertStatus(`<span class="warn">Kh√¥ng th·∫•y new.fullAddress.</span> ƒê√£ ƒë·ªï JSON v√†o √¥ k·∫øt qu·∫£.`);
        return;
      }
      $("newAddr").value = notes ? `${newFull}\n\nGhi ch√∫: ${notes}` : newFull;
      setConvertStatus(`<span class="oktxt">Th√†nh c√¥ng!</span> ƒê·ªãa ch·ªâ m·ªõi ƒë√£ c·∫≠p nh·∫≠t.`);
    } catch (e) {
      setConvertStatus(`<span class="error">L·ªói:</span> ${e.message}`);
    }
  });

  // ===== Support badge
  (function(){
    const ok = ("BarcodeDetector" in window);
    $("support").innerHTML = ok
      ? `<span class="oktxt">‚úÖ Tr√¨nh duy·ªát h·ªó tr·ª£ BarcodeDetector</span>`
      : `<span class="warn">‚ö†Ô∏è Kh√¥ng h·ªó tr·ª£ BarcodeDetector (Safari/iOS hay g·∫∑p)</span>`;
  })();
</script>
</body>
</html>
